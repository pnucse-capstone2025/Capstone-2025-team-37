# Minimal Makefile for building only coffee-aot (placed in chaincode/)

WASI_SDK_PATH ?= /opt/wasi-sdk
WASI_CLANG := $(WASI_SDK_PATH)/bin/clang

# wamrc path can be overridden: make WAMRC=/path/to/wamrc coffee-aot
WAMRC ?= /opt/watz/runtime/wamr-compiler/build/wamrc

SRC := coffee_chaincode_wasm.c
WASM := coffee_chaincode.wasm
AOT := coffee_chaincode.aot

.PHONY: all coffee-wasm coffee-aot clean help

all: coffee-aot

coffee-wasm:
	@echo "Building coffee_chaincode.wasm (using WASI-SDK: $(WASI_SDK_PATH))"
	@[ -x "$(WASI_CLANG)" ] || (echo "âŒ $(WASI_CLANG) ê°€ ì—†ìŠµë‹ˆë‹¤. WASI-SDKë¥¼ ì„¤ì¹˜í•˜ê±°ë‚˜ WASI_SDK_PATHë¥¼ ì„¤ì •í•˜ì„¸ìš”." && false)
	@$(WASI_CLANG) --target=wasm32 -nostdlib -O1 \
		-Wl,--no-entry \
		-Wl,--export=main \
		-Wl,--export=step_init \
		-Wl,--export=step_resume \
		-Wl,--initial-memory=524288 \
		-Wl,--max-memory=1048576 \
		-Wl,--stack-first \
		-Wl,--allow-undefined \
		-o $(WASM) $(SRC) || (echo "clang/wasm-ld ë¹Œë“œ ì‹¤íŒ¨ (WASI-SDK ì„¤ì¹˜ í™•ì¸)" && false)
	@echo "âœ… WASM ë¹Œë“œ ì™„ë£Œ: $(WASM)"

coffee-aot: coffee-wasm
	@echo "Converting to AOT (wamrc)"
	@[ -x "$(WAMRC)" ] || (echo "âŒ $(WAMRC) ê°€ ì—†ìŠµë‹ˆë‹¤. wamrcë¥¼ ë¹Œë“œí•˜ê±°ë‚˜ ê²½ë¡œë¥¼ ì„¤ì •í•˜ì„¸ìš”." && false)
	@$(WAMRC) \
		--target=aarch64 \
		--bounds-checks=0 \
		--size-level=3 \
		--opt-level=2 \
		--disable-aux-stack-check \
		-o $(AOT) $(WASM) || (echo "wamrc not found or failed" && false)
	@echo "âœ… AOT ë³€í™˜ ì™„ë£Œ: $(AOT)"
	@echo "ğŸ“Š AOT íŒŒì¼ í¬ê¸°: $$(ls -lh $(AOT) | awk '{print $$5}')"

clean:
	rm -f $(WASM) $(AOT)
	@echo "ğŸ§¹ ì •ë¦¬ ì™„ë£Œ"

help:
	@echo "coffee-aot ì „ìš© Makefile (chaincode/ ê²½ë¡œ)"
	@echo "\nì‚¬ìš©ë²•:"
	@echo "  make           # ê¸°ë³¸: coffee-aot"
	@echo "  make coffee-aot # WASMâ†’AOT ë³€í™˜ê¹Œì§€"
	@echo "  make clean      # ì‚°ì¶œë¬¼ ì •ë¦¬"
	@echo "\ní™˜ê²½ ë³€ìˆ˜:"
	@echo "  WASI_SDK_PATH=/opt/wasi-sdk (ê¸°ë³¸)"
	@echo "  WAMRC=/opt/watz/runtime/wamr-compiler/build/wamrc (ê¸°ë³¸)"

