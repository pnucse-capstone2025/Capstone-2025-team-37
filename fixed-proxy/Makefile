# Fixed Chaincode Proxy with gRPC and WASM Support
# iMX.EVK ë³´ë“œ ì „ìš© (OP-TEE TA ì‹¤í–‰ í™˜ê²½ í•„ìš”)

# ë³´ë“œìš© í¬ë¡œìŠ¤ ì»´íŒŒì¼ ì„¤ì •
CXX = aarch64-linux-gnu-g++
CXXFLAGS = -Wall -Wextra -std=c++11 -g -O2
# gRPC ì •ì  ë¼ì´ë¸ŒëŸ¬ë¦¬ ê²½ë¡œ
GRPC_LIB_PATH = /home/ubuntu/grpc/libs/opt
PROTOBUF_LIB_PATH = /home/ubuntu/grpc/libs/opt/protobuf

LDFLAGS = -lteec $(GRPC_LIB_PATH)/libgrpc++.a $(GRPC_LIB_PATH)/libgrpc.a $(PROTOBUF_LIB_PATH)/libprotobuf.a $(GRPC_LIB_PATH)/libgpr.a $(GRPC_LIB_PATH)/libaddress_sorting.a $(GRPC_LIB_PATH)/libares.a $(GRPC_LIB_PATH)/libboringssl.a -lpthread -ldl -lz

# ê³µí†µ ì„¤ì •
BINARY = fixed_chaincode_proxy_arm64
SRCS = main.cpp invocation.pb.cc invocation.grpc.pb.cc
OBJS = main.o invocation.pb.o invocation.grpc.pb.o

# OP-TEE í´ë¼ì´ì–¸íŠ¸ ë¼ì´ë¸ŒëŸ¬ë¦¬ ê²½ë¡œ (buildroot sysroot)
BUILDROOT_SYSROOT = /opt/watz/out-br/host/aarch64-buildroot-linux-gnu/sysroot
CXXFLAGS += -I./ta/include -I$(BUILDROOT_SYSROOT)/usr/include -Iinclude --sysroot=$(BUILDROOT_SYSROOT)
LDFLAGS += -L$(BUILDROOT_SYSROOT)/usr/lib --sysroot=$(BUILDROOT_SYSROOT)

$(info ===========================================)
$(info Fixed Chaincode Proxy - ë³´ë“œ ì „ìš© ë¹Œë“œ)
$(info íƒ€ê²Ÿ: iMX.EVK ë³´ë“œ (ARM64))
$(info ì»´íŒŒì¼ëŸ¬: $(CXX))
$(info ë°”ì´ë„ˆë¦¬: $(BINARY))
$(info SYSROOT: $(BUILDROOT_SYSROOT))
$(info ===========================================)

# ë¹Œë“œ ê·œì¹™
.PHONY: all
all: $(BINARY)

$(BINARY): $(OBJS)
	$(CXX) -o $@ $^ $(LDFLAGS)
	@echo "âœ… Fixed Chaincode Proxy ë¹Œë“œ ì™„ë£Œ: $(BINARY)"

%.o: %.cpp
	$(CXX) $(CXXFLAGS) -c $< -o $@

%.o: %.cc
	$(CXX) $(CXXFLAGS) -c $< -o $@

# Proto íŒŒì¼ì—ì„œ gRPC ì½”ë“œ ìƒì„±
.PHONY: proto
proto:
	@echo "ğŸ”§ Generating gRPC code from proto files..."
	protoc -I . --grpc_out=. --plugin=protoc-gen-grpc=$$(which grpc_cpp_plugin) invocation.proto
	protoc -I . --cpp_out=. invocation.proto
	@echo "âœ… gRPC ì½”ë“œ ìƒì„± ì™„ë£Œ"

# ì •ë¦¬
clean:
	rm -f $(OBJS) $(BINARY) fixed_chaincode_proxy_arm64
	rm -f *.pb.cc *.pb.h
	@echo "ğŸ§¹ ë¹Œë“œ íŒŒì¼ë“¤ì´ ì •ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤."

# ì¢…ì†ì„± ì„¤ì¹˜ ì•ˆë‚´
.PHONY: deps
deps:
	@echo "ğŸ“¦ í•„ìš”í•œ ì¢…ì†ì„± ì„¤ì¹˜:"
	@echo ""
	@echo "Ubuntu/Debian (í˜¸ìŠ¤íŠ¸ ê°œë°œìš©):"
	@echo "  sudo apt update"
	@echo "  sudo apt install -y libteec-dev libgrpc++-dev libprotobuf-dev protobuf-compiler-grpc"
	@echo ""
	@echo "OP-TEE í™˜ê²½ (ë³´ë“œìš©):"
	@echo "  gRPC ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ buildroot sysrootì— ì„¤ì¹˜ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤."

# í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (gRPC ì„œë²„ í…ŒìŠ¤íŠ¸)
test: $(BINARY)
	@echo "ğŸš€ gRPC ì„œë²„ í…ŒìŠ¤íŠ¸"
	@echo "âš ï¸  ì£¼ì˜ì‚¬í•­:"
	@echo "   - OP-TEE TAê°€ ë¡œë“œë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤"
	@echo "   - chaincode_wrapperê°€ gRPC í´ë¼ì´ì–¸íŠ¸ë¡œ ì—°ê²°í•´ì•¼ í•©ë‹ˆë‹¤"
	@echo ""
	@echo "ì„œë²„ ì‹œì‘: ./$(BINARY)"
	@echo "í¬íŠ¸: 50051"

# ë„ì›€ë§
help:
	@echo "ğŸ”§ Fixed Chaincode Proxy with gRPC and WASM Support (ë³´ë“œ ì „ìš©)"
	@echo ""
	@echo "ì£¼ìš” íƒ€ê²Ÿ:"
	@echo "  make              # iMX.EVK ë³´ë“œìš© í”„ë¡ì‹œ ë¹Œë“œ"
	@echo "  make proto        # Proto íŒŒì¼ì—ì„œ gRPC ì½”ë“œ ìƒì„±"
	@echo "  make clean        # ë¹Œë“œ íŒŒì¼ ì •ë¦¬"
	@echo ""
	@echo "ë¹Œë“œ ê²°ê³¼:"
	@echo "  ë°”ì´ë„ˆë¦¬: $(BINARY)"
	@echo "  ì‹¤í–‰ ìœ„ì¹˜: iMX.EVK ë³´ë“œ"
	@echo "  í¬íŠ¸: 50051 (gRPC ì„œë²„)"
	@echo ""
	@echo "ì „ì œì¡°ê±´:"
	@echo "  - aarch64-linux-gnu-g++ í¬ë¡œìŠ¤ ì»´íŒŒì¼ëŸ¬"
	@echo "  - /opt/watz buildroot í™˜ê²½ (libteec, gRPC ë¼ì´ë¸ŒëŸ¬ë¦¬ í¬í•¨)"

.PHONY: all clean help proto deps test